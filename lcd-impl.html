import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
Smile, Frown, AlertCircle, Moon, Activity,
Battery, Wifi, Pill, Clock, Bell, Phone
} from 'lucide-react';

// --- íƒ€ì… ì •ì˜ ---
// ë¡œë´‡ì˜ "ìƒí™©(Context)"ì„ ì •ì˜í•©ë‹ˆë‹¤. í‘œì •ë³´ë‹¤ ë” ìƒìœ„ ê°œë…ì…ë‹ˆë‹¤.
type RobotMode = 'IDLE' | 'GREETING' | 'MEDICATION' | 'SCHEDULE' | 'LISTENING' | 'EMERGENCY' | 'SLEEP';

interface RobotState {
mode: RobotMode;
emotion: 'neutral' | 'happy' | 'angry' | 'surprised' | 'sleep' | 'suspicious';
message?: string;
subMessage?: string;
}

// --- ë””ìì¸ í† í° (ë¬¸ì„œ ê¸°ë°˜ + ë¡œë´‡ í…Œë§ˆ) ---
const COLORS = {
primary: '#3182F6', // Toss Blue (UI ë²„íŠ¼ìš©)
eye: '#22d3ee', // Cyan (ë¡œë´‡ ëˆˆìš©)
eyeGlow: 'rgba(34, 211, 238, 0.6)',
bg: '#000000',
danger: '#F04452',
safe: '#00C471',
text: '#ffffff',
textSub: '#9ca3af',
};

const RobotFace = () => {
// í˜„ì¬ ë¡œë´‡ì˜ ìƒíƒœ
const [state, setState] = useState<RobotState>({
    mode: 'IDLE',
    emotion: 'neutral',
    message: '"í• ë¨¸ë‹ˆ~ ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”!"',
    subMessage: 'ë‹¤ìŒ ì¼ì •: ë³‘ì› ë°©ë¬¸ (ì˜¤í›„ 2:00)'
    });

    const [isBlinking, setIsBlinking] = useState(false);
    const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
    const [currentTime, setCurrentTime] = useState(new Date());

    // --- ì‹œê³„ ì—…ë°ì´íŠ¸ ---
    useEffect(() => {
    const timer = setInterval(() => setCurrentTime(new Date()), 1000);
    return () => clearInterval(timer);
    }, []);

    // --- ìë™ ê¹œë¹¡ì„ ë¡œì§ (ìˆ˜ë©´ ëª¨ë“œ ì œì™¸) ---
    useEffect(() => {
    let timeoutId: NodeJS.Timeout;
    const scheduleBlink = () => {
    const nextBlinkTime = Math.random() * 3000 + 2000;
    timeoutId = setTimeout(() => {
    if (state.mode !== 'SLEEP') {
    setIsBlinking(true);
    setTimeout(() => {
    setIsBlinking(false);
    scheduleBlink();
    }, 150);
    }
    }, nextBlinkTime);
    };
    scheduleBlink();
    return () => clearTimeout(timeoutId);
    }, [state.mode]);

    // --- ë§ˆìš°ìŠ¤ ì¶”ì  ---
    const handleMouseMove = (e: React.MouseEvent) => {
    const x = (e.clientX / window.innerWidth) * 2 - 1;
    const y = (e.clientY / window.innerHeight) * 2 - 1;
    setMousePos({ x, y });
    };

    // --- ëˆˆ ëª¨ì–‘ ì •ì˜ (Variants) ---
    const eyeVariants = {
    neutral: { height: 240, width: 180, borderRadius: "50%" },
    happy: { height: 160, width: 200, borderRadius: "40% 40% 60% 60%", y: -10 },
    angry: { height: 220, width: 180, borderRadius: "100% 0% 50% 50%" },
    surprised: { height: 280, width: 200, borderRadius: "50%", scale: 1.1 },
    sleep: { height: 15, width: 220, borderRadius: "10px", opacity: 0.4 },
    suspicious: { height: 100, width: 200, borderRadius: "10px 10px 50% 50%" },
    blink: { height: 8, width: 200, borderRadius: "50%", scaleY: 0.5 },
    };

    // ëª¨ë“œì— ë”°ë¥¸ ëˆˆì˜ ì „ì²´ì ì¸ ìœ„ì¹˜ì™€ í¬ê¸° ì¡°ì ˆ (í•µì‹¬!)
    const containerVariants = {
    center: { y: 0, scale: 1 },
    top: { y: -120, scale: 0.6 }, // ë©”ì‹œì§€ê°€ ëœ° ë•Œ ëˆˆì´ ì‘ì•„ì§€ê³  ìœ„ë¡œ ì´ë™
    };

    // í˜„ì¬ ë Œë”ë§í•  ëˆˆ ëª¨ì–‘
    const currentEyeVariant = isBlinking ? 'blink' : state.emotion;

    // ëˆˆì´ ìœ„ë¡œ ì˜¬ë¼ê°€ì•¼ í•˜ëŠ” ëª¨ë“œì¸ì§€ í™•ì¸
    const isCompactMode = ['GREETING', 'MEDICATION', 'SCHEDULE', 'LISTENING', 'EMERGENCY'].includes(state.mode);

    // ê¸´ê¸‰ ìƒí™© ë°°ê²½ ì ë©¸ íš¨ê³¼
    const isEmergency = state.mode === 'EMERGENCY';

    return (
    <div className={`w-full h-screen flex flex-col items-center overflow-hidden relative transition-colors
        duration-500`} style={{ backgroundColor: isEmergency ? '#300000' : COLORS.bg }} onMouseMove={handleMouseMove}>
        {/* --- ê¸´ê¸‰ ìƒí™© ë°°ê²½ ì• ë‹ˆë©”ì´ì…˜ --- */}
        {isEmergency && (
        <motion.div animate={{ opacity: [0, 0.5, 0] }} transition={{ repeat: Infinity, duration: 0.8 }}
            className="absolute inset-0 bg-red-600 z-0 pointer-events-none" />
        )}

        {/* --- ìƒë‹¨ ìƒíƒœë°” (Top Bar) --- */}
        <div
            className="w-full px-8 py-4 flex justify-between items-center z-50 text-white/80 font-mono text-lg absolute top-0">
            <div className="flex items-center gap-2">
                <Clock size={20} />
                {currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
            </div>
            <div className="flex items-center gap-4">
                <div className="flex items-center gap-2">
                    <Wifi size={20} />
                    <span className="text-sm">ì—°ê²°ë¨</span>
                </div>
                <div className="flex items-center gap-2">
                    <Battery size={20} />
                    <span className="text-sm">85%</span>
                </div>
            </div>
        </div>

        {/* --- ë©”ì¸ ì˜ì—­ (ëˆˆ + ë©”ì‹œì§€) --- */}
        <div className="flex-1 w-full flex flex-col items-center justify-center relative z-10 px-4">

            {/* 1. ëˆˆ ì˜ì—­ (ê°€ë³€ ë ˆì´ì•„ì›ƒ) */}
            <motion.div animate={isCompactMode ? "top" : "center" } variants={containerVariants} transition={{
                type: "spring" , stiffness: 100, damping: 20 }} className="flex items-center gap-12 sm:gap-24 relative">
                <Eye variant={currentEyeVariant} variants={eyeVariants} side="left" mousePos={mousePos}
                    emotion={state.emotion} />
                <Eye variant={currentEyeVariant} variants={eyeVariants} side="right" mousePos={mousePos}
                    emotion={state.emotion} />
            </motion.div>

            {/* 2. í•˜ë‹¨ ë©”ì‹œì§€ ë° ì»¨íŠ¸ë¡¤ ì˜ì—­ (AnimatePresenceë¡œ ë¶€ë“œëŸ½ê²Œ ì „í™˜) */}
            <AnimatePresence mode='wait'>
                {/* IDLE ëª¨ë“œ: ê°„ë‹¨í•œ ìƒíƒœ ë©”ì‹œì§€ */}
                {state.mode === 'IDLE' && (
                <motion.div key="idle" initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity:
                    0, y: -20 }} className="absolute bottom-32 text-center space-y-2">
                    <h2 className="text-2xl font-bold text-white/90">{state.message}</h2>
                    {state.subMessage && (
                    <div
                        className="flex items-center justify-center gap-2 text-cyan-400 bg-cyan-950/30 px-4 py-2 rounded-full backdrop-blur-sm border border-cyan-800/50">
                        <Activity size={16} />
                        <span className="text-sm">{state.subMessage}</span>
                    </div>
                    )}
                </motion.div>
                )}

                {/* GREETING / SCHEDULE / LISTENING: í…ìŠ¤íŠ¸ ìœ„ì£¼ */}
                {['GREETING', 'SCHEDULE', 'LISTENING'].includes(state.mode) && (
                <motion.div key="content" initial={{ opacity: 0, y: 50 }} animate={{ opacity: 1, y: 0 }} exit={{
                    opacity: 0, y: 50 }} className="absolute bottom-20 w-full max-w-3xl text-center space-y-6">
                    {state.mode === 'LISTENING' && (
                    <div className="flex justify-center mb-4 gap-2">
                        {[1, 2, 3].map(i => (
                        <motion.div key={i} animate={{ height: [10, 40, 10] }} transition={{ repeat: Infinity, duration:
                            1, delay: i * 0.2 }} className="w-2 bg-cyan-400 rounded-full" />
                        ))}
                    </div>
                    )}
                    <h1 className="text-4xl md:text-5xl font-bold text-white leading-tight whitespace-pre-line">
                        {state.message}
                    </h1>
                    {state.subMessage && (
                    <p className="text-xl text-gray-300 bg-gray-900/50 inline-block px-6 py-3 rounded-2xl">
                        {state.subMessage}
                    </p>
                    )}
                </motion.div>
                )}

                {/* MEDICATION: ë³µì•½ ì•Œë¦¼ (í° ë²„íŠ¼) */}
                {state.mode === 'MEDICATION' && (
                <motion.div key="medication" initial={{ opacity: 0, y: 100 }} animate={{ opacity: 1, y: 0 }} exit={{
                    opacity: 0, y: 100 }}
                    className="absolute bottom-12 w-full max-w-4xl px-4 flex flex-col items-center gap-8">
                    <div className="text-center space-y-2">
                        <div className="flex justify-center gap-2 mb-2">
                            <Pill size={40} className="text-yellow-400 animate-bounce" />
                            <Pill size={40} className="text-pink-400 animate-bounce delay-100" />
                            <Pill size={40} className="text-white animate-bounce delay-200" />
                        </div>
                        <h1 className="text-4xl font-bold text-white">{state.message}</h1>
                        <p className="text-xl text-yellow-300">{state.subMessage}</p>
                    </div>

                    <div className="flex w-full gap-4 justify-center">
                        <button
                            className="flex-1 max-w-sm bg-[#00C471] hover:bg-[#00A05B] text-white text-3xl font-bold py-8 rounded-3xl shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-3"
                            onClick={()=> setState(prev => ({ ...prev, mode: 'IDLE', emotion: 'happy', message: '"ì˜í•˜ì…¨ì–´ìš”!
                            ê±´ê°•í•˜ì„¸ìš”~"' }))}
                            >
                            <Smile size={36} /> ì‘, ë¨¹ì—ˆì–´~
                        </button>
                        <button
                            className="flex-1 max-w-sm bg-gray-700 hover:bg-gray-600 text-gray-200 text-3xl font-bold py-8 rounded-3xl shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-3"
                            onClick={()=> setState(prev => ({ ...prev, mode: 'IDLE', emotion: 'neutral', message: '"ë‚˜ì¤‘ì—
                            ë‹¤ì‹œ ì•Œë ¤ë“œë¦´ê²Œìš”."' }))}
                            >
                            ì•„ì§ì´ì•¼
                        </button>
                    </div>
                </motion.div>
                )}

                {/* EMERGENCY: ê¸´ê¸‰ ìƒí™© (ê°€ì¥ ê°•ì¡°) */}
                {state.mode === 'EMERGENCY' && (
                <motion.div key="emergency" initial={{ scale: 0.8, opacity: 0 }} animate={{ scale: 1, opacity: 1 }}
                    exit={{ opacity: 0 }}
                    className="absolute bottom-16 w-full max-w-2xl px-6 flex flex-col items-center gap-6">
                    <div className="text-center space-y-2 animate-pulse">
                        <h1 className="text-5xl font-bold text-red-500 bg-black/50 px-4 py-2 rounded-lg">ğŸš¨ ê¸´ê¸‰ ìƒí™© ğŸš¨
                        </h1>
                        <p className="text-3xl text-white font-bold">{state.message}</p>
                    </div>

                    <button
                        className="w-full bg-red-600 hover:bg-red-700 text-white text-4xl font-bold py-8 rounded-3xl shadow-[0_0_50px_rgba(220,38,38,0.5)] flex items-center justify-center gap-4 animate-pulse">
                        <Phone size={40} /> 119 êµ¬ì¡° ìš”ì²­
                    </button>
                    <button className="w-full bg-white text-black text-3xl font-bold py-6 rounded-3xl shadow-lg"
                        onClick={()=> setState({ mode: 'IDLE', emotion: 'neutral', message: '"ë‹¤í–‰ì´ì—ìš”. ì¡°ì‹¬í•˜ì„¸ìš”!"' })}
                        >
                        ê´œì°®ì•„ìš”, ì˜¤ì¸ ê°ì§€
                    </button>
                </motion.div>
                )}
            </AnimatePresence>
        </div>

        {/* --- ê°œë°œììš© ì‹œë‚˜ë¦¬ì˜¤ ì»¨íŠ¸ë¡¤ëŸ¬ (ìš°ì¸¡ í•˜ë‹¨) --- */}
        <div className="absolute right-4 bottom-4 flex flex-col gap-2 z-[100]">
            <div
                className="bg-black/80 backdrop-blur border border-gray-800 p-3 rounded-xl flex flex-col gap-2 shadow-2xl">
                <p className="text-xs text-gray-500 font-mono mb-1 text-center">SCENARIO TEST</p>
                <ScenarioButton label="1. í‰ìƒì‹œ (Idle)" onClick={()=> setState({ mode: 'IDLE', emotion: 'neutral',
                    message: '"í• ë¨¸ë‹ˆ~ ì‹¬ì‹¬í•´ìš”~"', subMessage: 'ë…¸ë˜ë¼ë„ ë¶€ë¥¼ê¹Œìš”?' })}
                    />
                    <ScenarioButton label="2. ê¸°ìƒ ì¸ì‚¬" onClick={()=> setState({ mode: 'GREETING', emotion: 'happy',
                        message: '"í• ë¨¸ë‹ˆ~ ì˜ ì£¼ë¬´ì…¨ì–´ìš”?\nì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì°¸ ì¢‹ì•„ìš”!"', subMessage: 'ì˜¤ëŠ˜ ë‚ ì”¨: ë§‘ìŒ â˜€ï¸' })}
                        />
                        <ScenarioButton label="3. ë³µì•½ ì•Œë¦¼" onClick={()=> setState({ mode: 'MEDICATION', emotion:
                            'neutral', message: '"í• ë¨¸ë‹ˆ~ ì•½ ë“œì‹¤ ì‹œê°„ì´ì—ìš”!"', subMessage: 'ì•„ì¹¨ì•½ (ê³ í˜ˆì••, ë‹¹ë‡¨) ğŸ’Š' })}
                            />
                            <ScenarioButton label="4. ì¼ì • ì•Œë¦¼" onClick={()=> setState({ mode: 'SCHEDULE', emotion:
                                'surprised', message: '"ìŠì§€ ë§ˆì„¸ìš”!\nê³§ ë³‘ì›ì— ê°€ì…”ì•¼ í•´ìš”."', subMessage: 'ì˜¤í›„ 2:00 ì„œìš¸ëŒ€ë³‘ì› ë‚´ê³¼' })}
                                />
                                <ScenarioButton label="5. ë“£ëŠ” ì¤‘" onClick={()=> setState({ mode: 'LISTENING', emotion:
                                    'happy', message: '"ë„¤, ë“£ê³  ìˆì–´ìš”...\në§ì”€í•´ ì£¼ì„¸ìš”!"' })}
                                    />
                                    <ScenarioButton label="6. ê¸´ê¸‰ ìƒí™©" onClick={()=> setState({ mode: 'EMERGENCY',
                                        emotion: 'surprised', message: 'ë‚™ìƒì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!\nê´œì°®ìœ¼ì‹ ê°€ìš”?!' })}
                                        danger
                                        />
                                        <ScenarioButton label="7. ì¶©ì „/ìˆ˜ë©´" onClick={()=> setState({ mode: 'SLEEP',
                                            emotion: 'sleep', message: '"ì € ì¶©ì „í•˜ê³  ì˜¬ê²Œìš”...\nì•ˆë…•íˆ ì£¼ë¬´ì„¸ìš” ğŸ’¤"', subMessage: 'ë°°í„°ë¦¬
                                            ì¶©ì „ ì¤‘ (75%)' })}
                                            />
            </div>
        </div>
    </div>
    );
    };

    // --- ì„œë¸Œ ì»´í¬ë„ŒíŠ¸ ---

    const Eye = ({ variant, variants, side, mousePos, emotion }: any) => {
    const shouldTrack = variant !== 'sleep' && variant !== 'blink' && emotion !== 'suspicious';
    const moveX = shouldTrack ? mousePos.x * 20 : 0;
    const moveY = shouldTrack ? mousePos.y * 20 : 0;

    // í™”ë‚œ í‘œì •ì¼ ë•Œ ë¯¸ê°„ ì°Œí‘¸ë¦¬ê¸°
    const angryRotation = side === 'left' ? -15 : 15;
    const rotation = emotion === 'angry' ? angryRotation : 0;

    return (
    <div className="relative">
        <motion.div animate={variant} variants={variants} transition={{ type: "spring" , stiffness: 300, damping: 25 }}
            style={{ backgroundColor: COLORS.eye, boxShadow: `0 0 50px 10px ${COLORS.eyeGlow}`, x: moveX, y: moveY,
            rotate: rotation, }} className="origin-center" />
        {/* ëˆˆë™ì í•˜ì´ë¼ì´íŠ¸ */}
        <AnimatePresence>
            {variant !== 'blink' && variant !== 'sleep' && (
            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 0.8 }} exit={{ opacity: 0 }}
                className="absolute top-[20%] right-[20%] w-8 h-8 bg-white rounded-full blur-[2px]" style={{ x: moveX,
                y: moveY }} />
            )}
        </AnimatePresence>
    </div>
    );
    };

    const ScenarioButton = ({ label, onClick, danger }: any) => (
    <button onClick={onClick} className={`px-3 py-2 rounded-lg text-xs font-bold transition-all text-left ${danger
        ? 'bg-red-900/30 text-red-400 hover:bg-red-900/50 border border-red-900'
        : 'bg-gray-800 text-gray-300 hover:bg-gray-700 border border-gray-700' } `}>
        {label}
    </button>
    );

    export default RobotFace;